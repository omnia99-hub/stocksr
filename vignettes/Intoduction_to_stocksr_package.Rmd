---
title: "Intoduction_to_stocksr_package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intoduction_to_stocksr_package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(stocksr)
```

## Overview

The `stocksr` package offers tools for preprocessing, analyzing, and modeling S&P 500 stock data organized by sector. It simplifies the end-to-end workflow of:

- **Loading and cleaning** historical S&P 500 price data
- **Computing sector-level indices** from company-level stock prices
- **Generating lag features and technical indicators** for forecasting
- **Training Random Forest models** to predict sector index movements
- **Evaluating model performance** using RMSE, MAE, and $R^2$

---

## Key Features

- **Sector-wise grouping**  
  Automatically maps companies to sectors like Technology, Financials, or Health Care.

- **Technical indicator generation**  
  Adds moving averages, returns, and momentum indicators for each sector's time series.

- **Random Forest pipeline**  
  Trains models using default or customizable parameters via the `caret` package.

- **Performance comparison**  
  Computes error metrics (RMSE, MAE, $R^2$) to benchmark models across different sectors.

- **Visualization**  
  Generates plots showing predicted vs actual sector index values and feature importance rankings.
  
## Overview

The `load_and_preprocess_data()` function in the **stocksr** package is designed to load historical S&P 500 stock price data from an Excel file and organize it into **sector-wise groups**. 

Each sector is returned as a separate data frame, containing:
- One column for `Date`
- One column per company within that sector

This function is especially useful for:
- Performing **sector-level financial analysis**
- Building **machine learning models** on grouped company data

---

## What the Function Does

The function performs the following steps:

-  **Reads** an Excel file where:
  - Rows represent daily price observations
  - Columns represent individual companies

- **Maps** each company to its corresponding sector  
  _(e.g., Energy, Health Care)_

- **Creates** a data frame for each sector that includes:
  - `Date` as the first column
  - Stock prices of the companies in that sector

- **Returns** a named list of sector-specific data frames
```{r example}
# Load and preprocess
sectors_data <- load_and_preprocess_data(df_cleaned2)

# View available sectors
names(sectors_data)
```
## View a Sample Sector

```{r preview-sector, message = FALSE, warning = FALSE}
# Preview the first few rows of the Energy sector
head(sectors_data$Energy)
```

## Sector Mapping Reference

The `load_and_preprocess_data()` function internally maps companies to the following sectors:

- **Energy:** Exxon Mobil, Chevron, ConocoPhillips, Schlumberger, EOG Resources, etc.
- **Health Care:** Johnson & Johnson, UnitedHealth Group, Eli Lilly, Pfizer, Merck & Company, etc.


## Return Value

The function returns a **named list of data frames**, where each name corresponds to a sector.

Each sector data frame contains:

- `Date`: The trading date  
- Stock prices for all companies in that sector (one column per company)

## Inspect Sector Data Structure
```{r}
# Check the structure of the Energy sector data
str(sectors_data$Energy)
```

## Calculating Sector Index from S&P 500 Data

The `calculate_sector_index()` function computes the **average stock price across all companies in a sector** for each date, creating a simple sector-level time series. This is especially useful as input for forecasting or machine learning models.

### How It Works

- Takes a **sector-specific data frame** (e.g., `sectors_data$Energy`) created using `load_and_preprocess_data()`
- Handles missing values using linear interpolation (`na.approx`) and bidirectional filling (`fill`)
- Computes a row-wise average of all company columns
- Returns a data frame with:
  - `Date`: The trading date
  - `sector_index`: The average of all company prices in that sector

### Apply to this Data

```{r calculate-sector-index, message = FALSE, warning = FALSE}
# Compute sector index for the Energy sector
tech_index <- calculate_sector_index(sectors_data$Energy)

# View the result
head(tech_index)
```

## Calculating Technical Indicators for Sector Index

The `calculate_technical_indicators()` function in the `stocksr` package enriches a sector index time series with widely used technical indicators. These features are valuable for capturing patterns like momentum, trend, and volatilityâ€”key components for predictive modeling in finance.

### What Are Technical Indicators?

The function calculates the following indicators:

#### *Daily Returns**

The daily return \( R_t \) is computed as the percent change from the previous day's index:

\[
R_t = \frac{P_t - P_{t-1}}{P_{t-1}}
\]

Where:
- \( P_t \) is the sector index at time \( t \)
- \( R_t \) is the return on day \( t \)


#### *Simple Moving Averages (SMA)**

The SMA over \( n \) days is:

\[
\text{SMA}_t = \frac{1}{n} \sum_{i=0}^{n-1} P_{t-i}
\]

Used for smoothing trends over time. The function includes:
- SMA over 5, 10, and 20 days

#### *Exponential Moving Averages (EMA)**

The EMA assigns more weight to recent prices. It's calculated recursively as:

\[
\text{EMA}_t = \alpha \cdot P_t + (1 - \alpha) \cdot \text{EMA}_{t-1}
\]

Where \( \alpha = \frac{2}{n+1} \) is the smoothing factor.

The function includes:
- EMA over 5 and 10 days

#### **Rolling Volatility**

The volatility (standard deviation) over a rolling window of \( n \) days:

\[
\text{Volatility}_t = \sqrt{ \frac{1}{n-1} \sum_{i=0}^{n-1} (P_{t-i} - \bar{P})^2 }
\]

Computed for 5 and 10-day windows.


#### **Relative Strength Index (RSI)**

The RSI measures the magnitude of recent gains and losses:

\[
\text{RSI} = 100 - \left( \frac{100}{1 + \frac{\text{Average Gain}}{\text{Average Loss}}} \right)
\]

Used to identify overbought (RSI > 70) or oversold (RSI < 30) conditions.

#### **Lagged Features**

For time series models, the function creates lagged values:

- \( \text{Lag}_k = P_{t-k} \)
- \( \text{Returns\_Lag}_k = R_{t-k} \) for \( k = 1 \) to \( 5 \)

These help capture short-term dependencies and trends.


### Apply to Sector Data

```{r sector-tech-indicators, message = FALSE, warning = FALSE}
tech_features <- calculate_technical_indicators(tech_index)
head(tech_features)
```


These engineered features are ready to be used in time series forecasting, machine learning pipelines, or financial dashboarding.

## Random Forest Modeling for Sector Index Prediction

The `build_random_forest_model()` function trains a **Random Forest regression model** to predict a sector's daily index using engineered features such as returns, lag values, and technical indicators. It evaluates the model using standard performance metrics and provides feature importance to interpret the model.

### What is a Random Forest?

A **Random Forest** is an ensemble machine learning algorithm that builds multiple decision trees and combines their predictions. In regression tasks, it averages the results from each tree to provide a robust, stable prediction.

**Why use Random Forests for financial data?**

- Handles non-linear relationships between features and response  
- Robust to noise and overfitting  
- Provides built-in feature importance for interpretation  
- Performs well on datasets with many engineered variables (like technical indicators)

### How the Function Works

The `build_random_forest_model()` function performs the following steps:

1. **Input**: A data frame with:
   - `Date`
   - `sector_index` (target)
   - Engineered features (technical indicators, returns, lags, etc.)

2. **Split the data**:
   - 80% for training
   - 20% for testing
   - Chronological order is preserved to respect time-dependence

3. **Train the model**:
   - A Random Forest is trained on the training set using `randomForest::randomForest()`  
   - Parameters include `ntree = 100`, `mtry = sqrt(p)`, `nodesize = 5`

4. **Evaluate**:
   - Calculates:
     - **RMSE** (Root Mean Squared Error)
     - **MAE** (Mean Absolute Error)
     - **\( R^2 \)** (Coefficient of Determination)
   - Plots actual vs predicted values

5. **Feature Importance**:
   - Displays top variables ranked by `IncNodePurity`

### Apply to Your Data

```{r build-rf-model, message = FALSE, warning = FALSE}
# Train and evaluate the model
rf_results <- build_random_forest_model(tech_features, "Energy")
```

### Output

The function returns a named list:

| Name               | Description                                                  |
|--------------------|--------------------------------------------------------------|
| `model`            | The trained `randomForest` object                            |
| `rmse`             | Root Mean Squared Error on the test set                      |
| `mae`              | Mean Absolute Error on the test set                          |
| `r2`               | R-squared score on the test set                              |
| `feature_importance` | Data frame ranking features by `IncNodePurity`            |

This modeling function is a key part of the `stocksr` pipeline and can be extended to all sectors for comparative performance analysis.

```{r}
# Step 3: View results
rf_results$rmse
rf_results$r2
head(rf_results$feature_importance)
```

